<div class=text-justify>
---
title: "PREDICCI√ìN DEL N√öMERO DE VEH√çCULOS REGISTRADOS EN EL SISTEMA DE TR√ÅNSITO NACIONAL"
author:
- Carlos Mario Calle Gonz√°lez
- Catherine Andrea C√≥rdoba Espinosa
- Allison Piedrahita Garc√≠a
- Santiago Ram√≠rez Zapata
- Jhonier Santiago Serna Cardona
date: "07/09/2021"
output:
  html_document:
    theme: united
    highlight: tango
  pdf_document: default
---

**Objetivo**: Crear un modelo para predecir el n√∫mero de veh√≠culos registrados diariamente en el Registro √önico Nacional de Tr√°nsito (RUNT) para el a√±o 2018 teniendo en cuenta que no debe haber una variaci√≥n mayor al 10% entre el $R^2$ calculado para los datos de entrenamiento y los datos de validaci√≥n. 

### Introducci√≥n
En el mundo actual donde el tiempo se convierte en dinero y la toma r√°pida de decisiones es un factor determinante para lograr rendimientos esperados, la capacidad de pronosticar y deducir resultados representa una gran ventaja competitiva. Por lo anterior, las t√©cnicas de predicci√≥n juegan un papel de suma importancia en todo tipo de aplicaciones, como por ejemplo las relacionadas con dise√±os de estrategias, an√°lisis de riesgos, compras y ventas, an√°lisis de patrones, entre otros; ya que a trav√©s de t√©cnicas computacionales y an√°lisis de datos se logra inferir la posibilidad de resultados en distintas situaciones, previas a su consecuci√≥n [1]. Para ilustrar lo anterior, el presente trabajo busca crear un modelo que prediga el n√∫mero de veh√≠culos registrados diariamente en el RUNT. Esto traer√≠a una gran ventaja organizacional para el sistema de tr√°nsito nacional, pues se podr√≠a preparar con anterioridad toda la log√≠stica necesaria en cada registro, evitando as√≠ molestias en sus usuarios por fallas en el sistema, ca√≠das en la red por gran cantidad de ingresos simult√°neos, colas innecesariamente largas, entre otras.

### Contextualizaci√≥n
Se cuenta con una base de datos con $2192$ registros de la cantidad de veh√≠culos inscritos en el RUNT. Las observaciones que se tienen son diarias entre el a√±o 2012 y el 2017. Con el fin de crear una base de datos robusta que logre explicar la cantidad de veh√≠culos registrados en el Registro √önico Nacional de Tr√°nsito, se agregan las variables explicativas que se describen a continuaci√≥n:

-   **$A√±o$:** Hace referencia al a√±o en el cual se encuentra la observaci√≥n en la base de datos. Puede variar de 2012 a 2017.
-   **$Mes$:** Variable categ√≥rica que determina el n√∫mero del mes del a√±o en el que se realiz√≥ el registro de veh√≠culos en el RUNT. La variable toma valores entre 1 y 12 dado la cantidad de meses en un a√±o (1:enero, 2:febrero, 3:marzo, 4:abril, 5:mayo, 6:junio, 7:julio, 8:agosto, 9:septiembre, 10:octubre, 11:noviembre, 12:diciembre)
-   **$D√≠a$:** Se refiere al n√∫mero del d√≠a del mes en el que fue registrada la observaci√≥n, tiene variaciones entre 1 y 31. 
-   **$D√≠a de la semana$:** Se refiere al d√≠a de la semana en el que se realiz√≥ el registro de un determinado n√∫mero de veh√≠culos en el RUNT. Es una variable categ√≥rica (Lunes, Martes, Mi√©rcoles, Jueves, Viernes, S√°bado, Domingo)
-    **$N√∫mero de semana en el mes$:** Se crea la variable con el fin de determinar el n√∫mero de la semana correspondiente al mes. Puede tomar valores entre 1 y 5. 
-   **$Feriado$:** Variable categ√≥rica que determina los d√≠as que no son laborables debido a alguna festividad. 
-   **$Importaciones$:** Describe las importaciones de veh√≠culos de transporte privado del mes inmediatamente anterior. 
-   **$TuCarro, Carroya, RevistaMotor$:** Comparaciones hechas con Google Trend de Tu carro, revista Motor, Carroya; se sospecha de esta relaci√≥n con la compra de veh√≠culo ya que es usual revisar estos sitios web para consultar los precios previo a una compra [2].
-   **$Unidades_vendidas_por_mes$:** Hace referencia al n√∫mero de carros vendidos mensualmente. Se espera que esta variable ayude a explicar cu√°ntos carros se inscriben en el RUNT.
-   **$Unidades_semanamenos1$:** Es la variaci√≥n existente entre la suma de los registros de la semana k del a√±o N y N-1. Donde k œµ [1, 52] y N œµ [2012, 2018]. Se tiene la hoip√≥tesis de que la serie se comporta ciclicamente, por lo que estaa variable puede contener esa estacionalidad. 
-   **$Unidadesmenos1, 2, 3, 4$:** Son variables que describen parte de la estacionalidad de la serie, dadas que son las diferencias entre las unidades registradas a√±o a a√±o. 

Finalmente, se construye una base de datos que contiene en total 18 variables en total, contando con la variable respuesta, la fecha de la observaci√≥n y las variables explicativas agregadas.

### Procesamiento
Teniendo en cuenta que el objetivo del trabajo plantea la divisi√≥n de resultados en rangos de a√±o, se realizan las siguientes divisiones de la base de datos:

-   Datos del 2012-2016
-   Datos del primer semestre de 2017
-   Datos del segundo semestre de 2017
-   Datos del primer semestre de 2018

Se procesa la base de datos para agregar las variables explicativas y dividirla en los a√±os en cuesti√≥n.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library("readxl")
datos <- read_excel("archivos/registros_autos_entrenamiento.xlsx")

#Fechas 2018
Fechas_2018 <- as.Date("2018-01-01",format= "%Y-%m-%d") + 0:364
Fechas_2018 <- data.frame(Fechas_2018)
names(Fechas_2018) <- c("Fecha")
Fechas_2018['Unidades'] <- NA
datos <- rbind(datos,Fechas_2018)
```

```{r message=FALSE, warning=FALSE}
##Creamos variable a√±o, mes y dia.
fechas <- as.Date(datos$Fecha)
datos$anio <- as.numeric(format(fechas,format = "%Y"))
datos$mes <- as.numeric(format(fechas,format = "%m"))
datos$dia <- as.numeric(format(fechas,format = "%d"))
```


```{r message=FALSE, warning=FALSE}
#Dia de la semana
datos$dia_semana <- weekdays(datos$Fecha)

#Numero de la semana por mes
monthweeks <- function(x) {
   as.character(ceiling(as.numeric(format(x, "%d")) / 7))
}
datos$numero_semana <- factor(lapply(datos$Fecha,monthweeks),levels = c("1","2","3","4","5"))
```


```{r message=FALSE, warning=FALSE}
###Dias festivos
datos$Fecha <- as.Date(datos$Fecha)
pascua <- function(x){#Dado un a√±o retorna la fecha de la pascua.
  #https://www.uv.es/sofuen/actividades/actividad4/fechadepascua.pdf
  x <- as.numeric(x)
  a <- x%%19
  b <- x%%4
  c <- x%%7
  d <- (19*a + 24)%%30
  e <- (2*b + 4*c + 6*d + 5)%%7
  M <- 24
  N <- 5
  if((22+d+e) < 32){
    return(as.Date(paste(as.character(x),"-03-",as.character((22+d+e)),sep = ""),format="%Y-%m-%d"))
  }
  else{
    return(as.Date(paste(as.character(x),"-04-",as.character(d+e-9),sep = ""),format="%Y-%m-%d"))
  }
}

mover_festivo <- function(x){ #Dada una fecha, mover el festivo a lunes.
 dia_semana <- weekdays(x)
 result = switch(
   dia_semana,
   "lunes"= x,
   "martes"= x+6,
   "mi√©rcoles"= x+5,
   "jueves"= x+4,
   "viernes"= x+3,
   "s√°bado"= x+2,
   "domingo"= x+1)


 return(result)

}

festivo <- function(x){#Dada una fecha retornar si es festivo
  
  anio <- format(x,format = "%Y")
  
  if(weekdays(x) == "domingo"){
    return(TRUE)
  }else{
    
  
  
  festivos <- c(as.Date(format(paste(as.character(anio),"-01-01",sep = ""),format = "%Y-%m-%d")),
                mover_festivo(as.Date(format(paste(as.character(anio),"-01-06",sep = ""),format = "%Y-%m-%d"))),
                mover_festivo(as.Date(format(paste(as.character(anio),"-03-19",sep = ""),format = "%Y-%m-%d"))),
                pascua(anio) - 3,
                pascua(anio) - 2,
                as.Date(format(paste(as.character(anio),"-05-01",sep = ""),format = "%Y-%m-%d")),
                mover_festivo(pascua(anio)+40),
                mover_festivo(pascua(anio)+60),
                mover_festivo(as.Date(format(paste(as.character(anio),"-06-11",sep = ""),format = "%Y-%m-%d"))),
                mover_festivo(as.Date(format(paste(as.character(anio),"-06-29",sep = ""),format = "%Y-%m-%d"))),
                as.Date(format(paste(as.character(anio),"-07-20",sep = ""),format = "%Y-%m-%d")),
                as.Date(format(paste(as.character(anio),"-08-07",sep = ""),format = "%Y-%m-%d")),
                mover_festivo(as.Date(format(paste(as.character(anio),"-08-15",sep = ""),format = "%Y-%m-%d"))),
                mover_festivo(as.Date(format(paste(as.character(anio),"-10-12",sep = ""),format = "%Y-%m-%d"))),
                mover_festivo(as.Date(format(paste(as.character(anio),"-11-01",sep = ""),format = "%Y-%m-%d"))),
                mover_festivo(as.Date(format(paste(as.character(anio),"-11-11",sep = ""),format = "%Y-%m-%d"))),
                as.Date(format(paste(as.character(anio),"-12-08",sep = ""),format = "%Y-%m-%d")),
                as.Date(format(paste(as.character(anio),"-12-25",sep = ""),format = "%Y-%m-%d")))
  
  return(x %in% festivos)
  }
  
}

datos$feriado <- lapply(datos$Fecha,festivo)
datos$feriado <- as.integer(datos$feriado == "TRUE")
datos$feriado <- factor(datos$feriado,levels = c(0,1))
```


```{r message=FALSE, warning=FALSE}
#Importaciones
importaciones <- read_excel("archivos/importaciones.xlsx")
datos <- as.data.frame(cbind(datos, importaciones))
```

```{r message=FALSE, warning=FALSE}
#Paginas web vehiculos, unidades vendidas al mes, vehiculos,unidadesmenos1,
library(magrittr)
library(dplyr)
library("readxl")
datos <- datos %>% filter(Fecha <= "2018-06-30")
consultas <- read_excel("Archivos/consultas.xlsx")
datos <- as.data.frame(cbind(datos, consultas))
```

A continuaci√≥n, se realiza la divisi√≥n de la base de datos seg√∫n los requerimientos y objetivos planteados:

```{r message=FALSE, warning=FALSE}
database_2012_2016 <- datos %>% filter(Fecha >= "2011-12-31" & Fecha <= "2016-12-31")
database_2017 <- datos %>% filter(Fecha >= "2016-12-31" & Fecha <= "2017-06-30")
database_2017_2 <-  datos %>% filter(Fecha >= "2017-06-30" & Fecha <= "2017-12-31")
database_2018 <- datos %>% filter(Fecha >= "2017-12-31" & Fecha <= "2018-06-30")
database_2018 <- database_2018[,-2]
```



### Desarrollo estad√≠stico
#### Modelo 1
En teor√≠a de probabilidad y estad√≠stica, la distribuci√≥n de Poisson es una distribuci√≥n de probabilidad discreta que expresa, a partir de una frecuencia de ocurrencia media, la probabilidad de que ocurra un determinado n√∫mero de eventos que ocurre en un intervalo temporal o espacial de tama√±o dado. Concretamente, se especializa en la probabilidad de ocurrencia de sucesos con probabilidades muy peque√±as, o sucesos "raros".
Fue descubierta por Sim√©on-Denis Poisson, que la dio a conocer en 1838 en su trabajo Recherches sur la probabilit√© des jugements en mati√®res criminelles et mati√®re civile (Investigaci√≥n sobre la probabilidad de los juicios en materias criminales y civiles) [3].

La funci√≥n de masa de probabilidad de la distribuci√≥n de Poisson se presenta en la Ecuaci√≥n 1.

$ùëì(ùë•,ùúÜ)= \frac{e^{-ùúÜ}ùúÜ^x}{ùë•!}\ ;   ùë•=0,1,‚Ä¶‚àû   (1)$

De donde:

-   x es el n√∫mero de ocurrencias del evento o fen√≥meno (la funci√≥n nos da la probabilidad de que el evento suceda precisamente k veces).
-   Œª es un par√°metro positivo que representa el n√∫mero de veces que se espera que ocurra el fen√≥meno durante un intervalo dado, cuyo valor coincide con el valor de varianza, lo que define para esta distribuci√≥n la llamada propiedad de ‚Äúequidispersi√≥n‚Äù.
-   Funci√≥n exponencial (e) es la base de los logaritmos naturales (e = 2,71828...)

Por otra parte, los modelos lineales generalizados son una generalizaci√≥n flexible de la regresi√≥n lineal ordinaria que permite variables de respuesta que tienen modelos de distribuci√≥n de errores distintos de una distribuci√≥n normal [4].

Un requisito del Modelo Lineal Generalizado MLG es que la distribuci√≥n de la variable de respuesta Y pertenezca a la familia exponencial. Se modela para que dependa de unas variables independientes ùëã de la forma que se presenta en la Ecuaci√≥n 2.

$ùê∏(ùíÄ) = ùúá = ùëî^{‚àí1} (ùëøùú∑)$

Donde:

-   La media de ùëå,$ùê∏[ùëå]=ùúá$
-   $ùëãùõΩ$ es el predictor lineal, con ùõΩ un vector de par√°metros desconocidos, generalmente g es conocida como la funci√≥n de enlace o de linkeo. Para estimar ùõΩ, se emplean m√©todos de verosimilitud, quasiverosimilitud o en ocasiones estad√≠stica bayesiana.

Teniendo en cuenta lo anterior, se plantea un Modelo Lineal Generalizado con respuesta Poisson que se evidencia en los siguientes algoritmos y cuya medida de $R^2$ se presenta a continuaci√≥n:

```{r message=FALSE, warning=FALSE}
library(rsq)
library(knitr)
mod1 <- glm(Unidades ~  mes + dia  + dia_semana + numero_semana +feriado+ impo + Unidadesmenos1+ unidades_vendidasalmes+unidades_semanamenos1+Unidadesmenos2 + Unidadesmenos4 , family = poisson(link = "log"), data = database_2012_2016)

R2mod1 <- data.frame(`R cuadrado modelo` = rsq(mod1), `R cuadrado ajustado` = rsq(mod1, adj = TRUE))

R2mod1 %>% kable(caption = "Modelo Lineal Generalizado", digits = 4, col.names = c("R^2 Modelo", "R^2 Ajustado"), align = "c")
```
Posteriormente, se obtienen los par√°metros del modelo como se muestra a continuaci√≥n:

![**Figura 1.** Par√°metros ajustados del modelo](Archivos/Imagen1.PNG){width=width height=height}

Y finalmente, se obtiene la ecuaci√≥n que describe al modelo elaborado:

![](Archivos/Imagen2.PNG){width=width height=height}

Asimismo, se verifican los supuestos de homocedasticidad, media cero e independencia y se obtienen las medidas de dispersi√≥n para los errores del modelo como se muestra a continuaci√≥n:

![**Figura 2.** Medidas de los residuales](Archivos/Imagen3.PNG){width=width height=height}

```{r}
plot(residuals(mod1) ~ predict(mod1,type="response"),xlab=expression(hat(mu)),ylab="Residuales",pch=20,col="red")
abline(h=0)
```

Para realizar la validaci√≥n del modelo, se realiza la predicci√≥n para el primer semestre del a√±o 2017 y se obtiene el $R^2$ correspondiente:

```{r}
predicion2017 <- round(predict(mod1, newdata = database_2017, type = "response", 0))

R2_2017 <- 1 - sum(((database_2017$Unidades-predicion2017)^2))/sum(((database_2017$Unidades-mean(database_2017$Unidades))^2))
kable(R2_2017, col.names = "R^2 Predicci√≥n 2017", align = "c", digits = 4)
```

Finalmente, dados los requerimientos del trabajo, se obtienen los archivos planos de las predicciones para los a√±os 2012-2016 y el primer semestre de 2018.
```{r}
predicion2012_2016 <- round(predict(mod1, data = database_2012_2016, type = "response"), 0)
predicion2012_2016datos <- data.frame(database_2012_2016$Fecha, predicion2012_2016)
names(predicion2012_2016datos)[1] <- "Fecha"
names(predicion2012_2016datos)[2] <- "Unidades"
write.csv(predicion2012_2016datos, "PrimerArchivoPlano.csv",row.names = FALSE)
```

```{r}
predicion2018 <- round(predict(mod1, newdata = database_2018, type = "response"), 0)
predicion2018datos <- data.frame(database_2018$Fecha, predicion2018)
names(predicion2018datos)[1] <- "Fecha"
names(predicion2018datos)[2] <- "Unidades"
write.csv(predicion2018datos, "SegundoArchivoPlano.csv",row.names = FALSE)
```

### Conclusiones y An√°lisis de resultados
-   El Modelo Lineal Generalizado, representa una excelente alternativa para la elaboraci√≥n de modelos relacionadas con respuesta Poisson. En este caso, el modelo creado logra capturar el comportamiento de la variable dependiente, lo cual se ve reflejado en el $R^2$ obtenido.
-   Los residuales del modelo presentan medidas de dispersi√≥n bajas y se comportan de buena manera, cumpliendo supuestos de varianza constante, media cero e independencia.
-   La mayor√≠a de las variables que alimentan el modelo son construidas a partir de caracter√≠sticas dadas por la fecha, por lo que el d√≠a y sus elementos asociados son importantes a la hora de pronosticar las unidades registradas.
-   La diferencia en el $R^2$ de entrenamiento y validaci√≥n es de 8.18%, lo cual refleja un buen comportamiento en el modelo elaborado.
-   El modelo podr√≠a mejorarse por medio de la adici√≥n de variables explicativas sobre la compra de veh√≠culos. En este trabajo, solo se reune una parte de las encontradas en la literatura, sin embargo, podr√≠a haber otras que mejoren el desempe√±o.

### Referencias

    [1].  "Qu√© es un modelo predictivo", Agenciab12.com, 2020. [En l√≠nea]. Disponible en: https://agenciab12.com/noticia/que-es-modelo-predictivo-como-aplica-negocio.
    [2] "Informe del sector automotor", Andi.com.co, 2021. [En l√≠nea]. Disponible en: http://www.andi.com.co/Uploads/2.%20INFORME%20DEL%20SECTOR%20AUTOMOTOR%20A%20FEBRERO%202017.pdf. [Acceso: 08- Sep- 2021].
    [3].    "Distribuci√≥n de Poisson - Wikipedia, la enciclopedia libre", Es.wikipedia.org. [en l√≠nea]. Disponible: https://es.wikipedia.org/wiki/Distribuci%C3%B3n_de_Poisson. [Acceso: 08- Sep- 2021].
    [4].   "Modelo lineal generalizado - Wikipedia, la enciclopedia libre", Es.wikipedia.org. [En l√≠nea]. Disponible en: https://es.wikipedia.org/wiki/Modelo_lineal_generalizado. [Acceso: 08- Sep- 2021].
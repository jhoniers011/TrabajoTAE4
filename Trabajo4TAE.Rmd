---
title: "Trabajo4TAE"
author: "Jhonier Santiago Serna Cardona"
date: "4/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library("readxl")
datos <- read_excel("archivos/registros_autos_entrenamiento.xlsx")

#Fechas 2018
Fechas_2018 <- as.Date("2018-01-01",format= "%Y-%m-%d") + 0:364
Fechas_2018 <- data.frame(Fechas_2018)
names(Fechas_2018) <- c("Fecha")
Fechas_2018['Unidades'] <- NA
datos <- rbind(datos,Fechas_2018)
```

```{r}
##Creamos variable año, mes y dia.
fechas <- as.Date(datos$Fecha)
datos$anio <- as.numeric(format(fechas,format = "%Y"))
datos$mes <- as.numeric(format(fechas,format = "%m"))
datos$dia <- as.numeric(format(fechas,format = "%d"))
```


```{r}
#Dia de la semana
datos$dia_semana <- weekdays(datos$Fecha)

#Numero de la semana por mes
monthweeks <- function(x) {
   as.character(ceiling(as.numeric(format(x, "%d")) / 7))
}
datos$numero_semana <- factor(lapply(datos$Fecha,monthweeks),levels = c("1","2","3","4","5"))
```


```{r}
###Dias festivos
datos$Fecha <- as.Date(datos$Fecha)
pascua <- function(x){#Dado un año retorna la fecha de la pascua.
  #https://www.uv.es/sofuen/actividades/actividad4/fechadepascua.pdf
  x <- as.numeric(x)
  a <- x%%19
  b <- x%%4
  c <- x%%7
  d <- (19*a + 24)%%30
  e <- (2*b + 4*c + 6*d + 5)%%7
  M <- 24
  N <- 5
  if((22+d+e) < 32){
    return(as.Date(paste(as.character(x),"-03-",as.character((22+d+e)),sep = ""),format="%Y-%m-%d"))
  }
  else{
    return(as.Date(paste(as.character(x),"-04-",as.character(d+e-9),sep = ""),format="%Y-%m-%d"))
  }
}

mover_festivo <- function(x){ #Dada una fecha, mover el festivo a lunes.
 dia_semana <- weekdays(x)
 result = switch(
   dia_semana,
   "lunes"= x,
   "martes"= x+6,
   "miércoles"= x+5,
   "jueves"= x+4,
   "viernes"= x+3,
   "sábado"= x+2,
   "domingo"= x+1)


 return(result)

}

festivo <- function(x){#Dada una fecha retornar si es festivo
  
  anio <- format(x,format = "%Y")
  
  if(weekdays(x) == "domingo"){
    return(TRUE)
  }else{
    
  
  
  festivos <- c(as.Date(format(paste(as.character(anio),"-01-01",sep = ""),format = "%Y-%m-%d")),
                mover_festivo(as.Date(format(paste(as.character(anio),"-01-06",sep = ""),format = "%Y-%m-%d"))),
                mover_festivo(as.Date(format(paste(as.character(anio),"-03-19",sep = ""),format = "%Y-%m-%d"))),
                pascua(anio) - 3,
                pascua(anio) - 2,
                as.Date(format(paste(as.character(anio),"-05-01",sep = ""),format = "%Y-%m-%d")),
                mover_festivo(pascua(anio)+40),
                mover_festivo(pascua(anio)+60),
                mover_festivo(as.Date(format(paste(as.character(anio),"-06-11",sep = ""),format = "%Y-%m-%d"))),
                mover_festivo(as.Date(format(paste(as.character(anio),"-06-29",sep = ""),format = "%Y-%m-%d"))),
                as.Date(format(paste(as.character(anio),"-07-20",sep = ""),format = "%Y-%m-%d")),
                as.Date(format(paste(as.character(anio),"-08-07",sep = ""),format = "%Y-%m-%d")),
                mover_festivo(as.Date(format(paste(as.character(anio),"-08-15",sep = ""),format = "%Y-%m-%d"))),
                mover_festivo(as.Date(format(paste(as.character(anio),"-10-12",sep = ""),format = "%Y-%m-%d"))),
                mover_festivo(as.Date(format(paste(as.character(anio),"-11-01",sep = ""),format = "%Y-%m-%d"))),
                mover_festivo(as.Date(format(paste(as.character(anio),"-11-11",sep = ""),format = "%Y-%m-%d"))),
                as.Date(format(paste(as.character(anio),"-12-08",sep = ""),format = "%Y-%m-%d")),
                as.Date(format(paste(as.character(anio),"-12-25",sep = ""),format = "%Y-%m-%d")))
  
  return(x %in% festivos)
  }
  
}

datos$feriado <- lapply(datos$Fecha,festivo)
datos$feriado <- as.integer(datos$feriado == "TRUE")
datos$feriado <- factor(datos$feriado,levels = c(0,1))
```


```{r}
#Importaciones
importaciones <- read_excel("archivos/importaciones.xlsx")
datos <- as.data.frame(cbind(datos, importaciones))
```

```{r}
#Paginas web vehiculos, unidades vendidas al mes, vehiculos,unidadesmenos1,
datos <- datos %>% filter(Fecha <= "2018-06-30")
consultas <- read_excel("Archivos/consultas.xlsx")
datos <- as.data.frame(cbind(datos, consultas))
```


###Separación en 3 bases de datos.
```{r}
database_2012_2016 <- datos %>% filter(Fecha >= "2011-12-31" & Fecha <= "2016-12-31")
database_2017 <- datos %>% filter(Fecha >= "2016-12-31" & Fecha <= "2017-06-30")
database_2017_2 <-  datos %>% filter(Fecha >= "2017-06-30" & Fecha <= "2017-12-31")
database_2018 <- datos %>% filter(Fecha >= "2017-12-31" & Fecha <= "2018-06-30")
database_2018 <- database_2018[,-2]
```


--------------------------------------------------------------------------------------------------------

### Modelo Lineal Generalizado con respuesta tipo Poisson

```{r, message=FALSE}
library(rsq)
library(knitr)
mod1 <- glm(Unidades ~  mes + dia  + dia_semana + numero_semana +feriado+ impo + Unidadesmenos1+ unidades_vendidasalmes+unidades_semanamenos1+Unidadesmenos2 + Unidadesmenos4 , family = poisson(link = "log"), data = database_2012_2016)


R2mod1 <- data.frame(`R cuadrado modelo` = rsq(mod1), `R cuadrado ajustado` = rsq(mod1, adj = TRUE))

R2mod1 %>% kable(caption = "Modelo Lineal Generalizado sin stepwise", digits = 4)
```


```{r}
summary(mod1)
```

Predicciones y R^2 para 2017 #validacion del modelo
```{r}
predicion2017 <- round(predict(mod1, newdata = database_2017, type = "response", 0))

R2_2017 <- 1 - sum(((database_2017$Unidades-predicion2017)^2))/sum(((database_2017$Unidades-mean(database_2017$Unidades))^2))
R2_2017

```

######Archivo plano de 2012 a 2016
```{r}
predicion2012_2016 <- round(predict(mod1, data = database_2012_2016, type = "response"), 0)
predicion2012_2016datos <- data.frame(database_2012_2016$Fecha, predicion2012_2016)
names(predicion2012_2016datos)[1] <- "Fecha"
names(predicion2012_2016datos)[2] <- "Unidades"
write.csv(predicion2012_2016datos, "PrimerArchivoPlano.csv",row.names = FALSE)
```

######Archivo plano del primer semestre del 2018
```{r}
predicion2018 <- round(predict(mod1, newdata = database_2018, type = "response"), 0)
predicion2018datos <- data.frame(database_2018$Fecha, predicion2018)
names(predicion2018datos)[1] <- "Fecha"
names(predicion2018datos)[2] <- "Unidades"
write.csv(predicion2018datos, "SegundoArchivoPlano.csv",row.names = FALSE)
```
